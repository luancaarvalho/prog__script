import { __decorate, __param, __read, __spread } from "tslib";
import { ChangeDetectorRef, Component, ElementRef, Inject, OnInit, QueryList, ViewChildren, } from '@angular/core';
import { FormControl } from '@angular/forms';
import { EventManager } from '@angular/platform-browser';
import { StateService } from './shared/state.service';
import { UrlService } from './shared/url.service';
import { fuzzySearch } from './shared/fuzzy-search.function';
import { LevenshteinDistance } from './shared/levenshtein-distance';
import { SandboxLoader } from './shared/sandbox-loader';
import { MIDDLEWARE } from '../lib/middlewares';
import { Observable } from 'rxjs';
import { debounceTime, distinctUntilChanged } from 'rxjs/operators';
var AppComponent = /** @class */ (function () {
    function AppComponent(stateService, urlService, eventManager, levenshteinDistance, changeDetectorRef, middleware) {
        this.stateService = stateService;
        this.urlService = urlService;
        this.eventManager = eventManager;
        this.levenshteinDistance = levenshteinDistance;
        this.changeDetectorRef = changeDetectorRef;
        this.middleware = middleware;
        this.commandBarActive = false;
        this.commandBarPreview = false;
        this.selectedSandboxAndScenarioKeys = { sandboxKey: null, scenarioKey: null };
        this.filter = new FormControl();
        this.shortcuts = this.getShortcuts();
        this.embed = false;
    }
    AppComponent.prototype.ngOnInit = function () {
        var _this = this;
        var sandboxMenuItems = SandboxLoader.getSandboxMenuItems();
        this.middleware
            .subscribe(function (middleware) { return _this.activeMiddleware = middleware; });
        this.embed = this.urlService.embed;
        if (this.embed) {
            this.selectedSandboxAndScenarioKeys = {
                sandboxKey: this.urlService.select.sandboxKey,
                scenarioKey: this.urlService.select.scenarioKey,
            };
        }
        else {
            if (this.urlService.select) {
                this.selectedSandboxAndScenarioKeys = {
                    sandboxKey: this.urlService.select.sandboxKey,
                    scenarioKey: this.urlService.select.scenarioKey,
                };
            }
            this.eventManager.addGlobalEventListener('window', 'keydown.control.p', this.blockEvent);
            this.eventManager.addGlobalEventListener('window', 'keydown.F2', this.blockEvent);
            this.eventManager.addGlobalEventListener('window', 'keyup.control.p', function (event) {
                _this.blockEvent(event);
                _this.toggleCommandBar();
            });
            this.eventManager.addGlobalEventListener('window', 'keyup.F2', function (event) {
                _this.blockEvent(event);
                _this.toggleCommandBar();
            });
            var filterValue = this.stateService.getFilter();
            this.totalSandboxes = sandboxMenuItems.length;
            this.filteredSandboxMenuItems = this.filterSandboxes(sandboxMenuItems, filterValue);
            this.filter.setValue(filterValue);
            this.filter.valueChanges.pipe(debounceTime(300), distinctUntilChanged())
                .subscribe(function (value) {
                _this.stateService.setFilter(value);
                _this.filteredSandboxMenuItems = _this.filterSandboxes(sandboxMenuItems, value);
                if (!value) {
                    _this.selectScenario(null, null);
                }
            });
        }
        // expose select scenario functionality for visual regression test
        window.loadScenario = function (sandboxKey, scenarioKey) {
            _this.selectScenario(sandboxKey, scenarioKey);
            _this.changeDetectorRef.detectChanges();
        };
        // set flag to check when component is loaded
        window.isPlaygroundComponentLoaded = function () { return false; };
        window.isPlaygroundComponentLoadedWithErrors = function () { return false; };
    };
    AppComponent.prototype.onFilterBoxArrowDown = function (event, switchToScenario) {
        if (switchToScenario === void 0) { switchToScenario = false; }
        event.preventDefault();
        var elementRef;
        var currentIndex = this.findCurrentScenarioIndex();
        if (currentIndex) {
            elementRef = this.focusScenarioLinkElement(currentIndex + 1);
        }
        else {
            elementRef = this.focusScenarioLinkElement(0);
        }
        if (switchToScenario) {
            this.showScenario(elementRef);
        }
    };
    AppComponent.prototype.onFilterBoxArrowUp = function (event, switchToScenario) {
        if (switchToScenario === void 0) { switchToScenario = false; }
        event.preventDefault();
        var elementRef;
        var currentIndex = this.findCurrentScenarioIndex();
        if (currentIndex) {
            elementRef = this.focusScenarioLinkElement(currentIndex - 1);
        }
        else if (this.scenarioLinkElements.length > 0) {
            elementRef = this.focusScenarioLinkElement(this.scenarioLinkElements.length - 1);
        }
        if (switchToScenario) {
            this.showScenario(elementRef);
        }
    };
    AppComponent.prototype.onScenarioLinkKeyDown = function (scenarioElement, filterElement, event) {
        event.preventDefault();
        switch (event.key) {
            case 'Up':
            case 'ArrowUp':
                this.goUp(scenarioElement);
                break;
            case 'Down':
            case 'ArrowDown':
                this.goDown(scenarioElement);
                break;
            default:
                if (event.key !== 'Escape' && event.key !== 'Enter') {
                    if (event.key.length === 1) {
                        this.filter.setValue("" + this.filter.value + event.key);
                    }
                    filterElement.focus();
                }
                break;
        }
    };
    AppComponent.prototype.onScenarioLinkKeyUp = function (scenarioElement, event) {
        event.preventDefault();
        switch (event.key) {
            case 'Escape':
                this.commandBarActive = false;
                break;
            case 'Enter':
                scenarioElement.click();
                break;
        }
    };
    AppComponent.prototype.onScenarioLinkControlDown = function (scenarioElement, event) {
        if (!this.commandBarActive)
            return;
        event.preventDefault();
        var elementRef = this.goDown(scenarioElement);
        this.showScenario(elementRef);
    };
    AppComponent.prototype.onScenarioLinkControlUp = function (scenarioElement, event) {
        if (!this.commandBarActive)
            return;
        event.preventDefault();
        var elementRef = this.goUp(scenarioElement);
        this.showScenario(elementRef);
    };
    AppComponent.prototype.onCommandBarStartPreview = function (event) {
        event.preventDefault();
        this.commandBarPreview = true;
    };
    AppComponent.prototype.onCommandBarStopPreview = function () {
        this.commandBarPreview = false;
    };
    AppComponent.prototype.onScenarioClick = function (sandboxKey, scenarioKey, event) {
        event.preventDefault();
        this.selectScenario(sandboxKey, scenarioKey);
    };
    AppComponent.prototype.isSelected = function (sandbox, scenario) {
        return this.selectedSandboxAndScenarioKeys.scenarioKey === scenario.key
            && this.selectedSandboxAndScenarioKeys.sandboxKey.toLowerCase() === sandbox.key.toLowerCase();
    };
    AppComponent.prototype.toggleCommandBar = function () {
        this.commandBarActive = !this.commandBarActive;
    };
    AppComponent.prototype.blockEvent = function (e) {
        e.preventDefault();
        e.stopPropagation();
    };
    AppComponent.prototype.showScenario = function (selectedScenarioElementRef) {
        if (selectedScenarioElementRef) {
            this.selectScenario(selectedScenarioElementRef.nativeElement.getAttribute('sandboxMenuItemKey'), parseInt(selectedScenarioElementRef.nativeElement.getAttribute('scenarioMenuItemkey'), 10));
        }
    };
    AppComponent.prototype.findCurrentScenarioIndex = function () {
        var currentIndex;
        if (this.scenarioLinkElements.length > 0) {
            this.scenarioLinkElements.map(function (element, i) {
                if (element.nativeElement.className.includes('selected')) {
                    currentIndex = i;
                }
            });
        }
        return currentIndex;
    };
    AppComponent.prototype.goUp = function (scenarioElement) {
        var currentIndex = -1;
        this.scenarioLinkElements.forEach(function (scenarioElementRef, index) {
            if (scenarioElementRef.nativeElement === scenarioElement) {
                currentIndex = index;
            }
        });
        if (currentIndex === 0) {
            return this.focusScenarioLinkElement(this.scenarioLinkElements.length - 1);
        }
        else {
            return this.focusScenarioLinkElement(currentIndex - 1);
        }
    };
    AppComponent.prototype.goDown = function (scenarioElement) {
        var currentIndex = -1;
        this.scenarioLinkElements.forEach(function (scenarioElementRef, index) {
            if (scenarioElementRef.nativeElement === scenarioElement) {
                currentIndex = index;
            }
        });
        if (currentIndex === this.scenarioLinkElements.length - 1) {
            return this.focusScenarioLinkElement(0);
        }
        else {
            return this.focusScenarioLinkElement(currentIndex + 1);
        }
    };
    AppComponent.prototype.focusScenarioLinkElement = function (index) {
        if (this.scenarioLinkElements.toArray()[index]) {
            var elementRef = this.scenarioLinkElements.toArray()[index];
            elementRef.nativeElement.focus();
            return elementRef;
        }
    };
    AppComponent.prototype.filterSandboxes = function (sandboxMenuItems, filter) {
        var _this = this;
        if (!filter) {
            return sandboxMenuItems.map(function (item, i) { return Object.assign({}, item, { tabIndex: i }); });
        }
        var tabIndex = 0;
        var filterNormalized = filter.toLowerCase();
        return sandboxMenuItems
            .reduce(function (accum, curr) {
            var searchKeyNormalized = curr.searchKey.toLowerCase();
            var indexMatches = fuzzySearch(filterNormalized, searchKeyNormalized);
            if (indexMatches) {
                var weight = _this.levenshteinDistance.getDistance(filterNormalized, searchKeyNormalized);
                return __spread(accum, [Object.assign({}, curr, { weight: weight, indexMatches: indexMatches })]);
            }
            else {
                return accum;
            }
        }, [])
            .sort(function (a, b) {
            return a.weight - b.weight;
        })
            .map(function (sandboxMenuItem) { return Object.assign({}, sandboxMenuItem, { tabIndex: tabIndex++ }); });
    };
    AppComponent.prototype.selectScenario = function (sandboxKey, scenarioKey) {
        // set flag to check when component is loaded
        window.isPlaygroundComponentLoaded = function () { return false; };
        window.isPlaygroundComponentLoadedWithErrors = function () { return false; };
        this.selectedSandboxAndScenarioKeys = { sandboxKey: sandboxKey, scenarioKey: scenarioKey };
        this.urlService.setSelected(sandboxKey, scenarioKey);
    };
    AppComponent.prototype.getShortcuts = function () {
        return [
            {
                keys: ['ctrl + p', 'f2'],
                description: 'Toggle command bar open/closed',
            },
            {
                keys: ['esc'],
                description: 'Close command bar',
            },
            {
                keys: ['\u2191', '\u2193'],
                description: 'Navigate up or down in command bar list',
            },
            {
                keys: ['ctrl + \u2191', 'ctrl + \u2193'],
                description: 'Switch scenarios while navigating up or down in command bar list',
            },
        ];
    };
    AppComponent.ctorParameters = function () { return [
        { type: StateService },
        { type: UrlService },
        { type: EventManager },
        { type: LevenshteinDistance },
        { type: ChangeDetectorRef },
        { type: Observable, decorators: [{ type: Inject, args: [MIDDLEWARE,] }] }
    ]; };
    __decorate([
        ViewChildren('scenarioElement')
    ], AppComponent.prototype, "scenarioLinkElements", void 0);
    AppComponent = __decorate([
        Component({
            selector: 'playground-root',
            template: "<div class=\"shield\" *ngIf=\"commandBarActive\" (click)=\"toggleCommandBar()\"></div>\n<div class=\"command-bar\" *ngIf=\"filteredSandboxMenuItems\"\n     (keydown.control)=\"onCommandBarStartPreview($event)\"\n     (keyup.control)=\"onCommandBarStopPreview()\"\n     [class.command-bar--open]=\"commandBarActive\"\n     [class.command-bar--preview]=\"commandBarPreview\">\n    <input\n        class=\"command-bar__filter\"\n        type=\"text\"\n        name=\"filter\"\n        placeholder=\"search...\"\n        [formControl]=\"filter\"\n        #filterElement\n        [apFocus]=\"commandBarActive\"\n        (keyup.Esc)=\"commandBarActive = false\"\n        (keydown.arrowup)=\"onFilterBoxArrowUp($event)\"\n        (keydown.arrowdown)=\"onFilterBoxArrowDown($event)\"\n        (keydown.control.arrowup)=\"onFilterBoxArrowUp($event, true)\"\n        (keydown.control.arrowdown)=\"onFilterBoxArrowDown($event, true)\">\n    <div *ngIf=\"filteredSandboxMenuItems && filteredSandboxMenuItems.length > 0\" class=\"command-bar__sandboxes\">\n        <div class=\"command-bar__sandbox\"\n             *ngFor=\"let sandboxMenuItem of filteredSandboxMenuItems; index as menuItemIndex\">\n            <h2 class=\"command-bar__title\" title=\"{{sandboxMenuItem.label}} {{sandboxMenuItem.name}}\"\n                [class.command-bar__sandbox-title--selected]=\"selectedSandboxAndScenarioKeys.sandboxKey === sandboxMenuItem.key\">\n                <span class=\"command-bar__name\"\n                      [innerHtml]=\"sandboxMenuItem.name | apHighlightSearchMatch : sandboxMenuItem.indexMatches\"></span>\n                <span class=\"command-bar__label\" *ngIf=\"sandboxMenuItem.label\"\n                      [innerHtml]=\"sandboxMenuItem.label | apHighlightSearchMatch : sandboxMenuItem.indexMatches : sandboxMenuItem.name.length\"></span>\n            </h2>\n            <div class=\"command-bar__scenarios\"\n                 *ngFor=\"let scenarioMenuItem of sandboxMenuItem.scenarioMenuItems; index as scenarioMenuItemIndex\">\n                <a\n                    class=\"command-bar__scenario-link\"\n                    #scenarioElement\n                    [tabindex]=\"scenarioMenuItem.tabIndex\"\n                    [attr.sandboxMenuItemKey]=\"sandboxMenuItem.key\"\n                    [attr.scenarioMenuItemkey]=\"scenarioMenuItem.key\"\n                    (keydown.control.arrowup)=\"onScenarioLinkControlUp(scenarioElement, $event)\"\n                    (keydown.control.arrowdown)=\"onScenarioLinkControlDown(scenarioElement, $event)\"\n                    (keydown.arrowup)=\"onScenarioLinkKeyDown(scenarioElement, filterElement, $event)\"\n                    (keydown.arrowdown)=\"onScenarioLinkKeyDown(scenarioElement, filterElement, $event)\"\n                    (keydown.esc)=\"onScenarioLinkKeyDown(scenarioElement, filterElement, $event)\"\n                    (keydown.enter)=\"onScenarioLinkKeyDown(scenarioElement, filterElement, $event)\"\n                    (keyup.esc)=\"onScenarioLinkKeyUp(scenarioElement, $event)\"\n                    (keyup.enter)=\"onScenarioLinkKeyUp(scenarioElement, $event)\"\n                    (click)=\"onScenarioClick(sandboxMenuItem.key, scenarioMenuItem.key, $event); toggleCommandBar()\"\n                    [class.command-bar__scenario-link--selected]=\"isSelected(sandboxMenuItem, scenarioMenuItem)\">\n                    <ap-pin [selected]=\"isSelected(sandboxMenuItem, scenarioMenuItem)\"></ap-pin>\n                    <span class=\"command-bar__scenario-label\">\n                  {{scenarioMenuItem.description}}\n                </span>\n                </a>\n            </div>\n        </div>\n    </div>\n    <a *ngIf=\"filteredSandboxMenuItems && filteredSandboxMenuItems.length > 0\" class=\"command-bar__brand\"\n       href=\"http://www.angularplayground.it/\" target=\"_blank\">\n        <ap-logo></ap-logo>\n    </a>\n</div>\n<section class=\"content\">\n    <ap-drawer *ngIf=\"!embed && activeMiddleware.overlay\" (openCommandBarClick)=\"toggleCommandBar()\" [class.content__menu--hide]=\"commandBarActive\" class=\"content__menu\"></ap-drawer>\n    <div class=\"content__none\" *ngIf=\"!selectedSandboxAndScenarioKeys.sandboxKey\">\n        <div class=\"content__none-message\">\n            <p *ngIf=\"totalSandboxes > 0\">\n                The playground has {{totalSandboxes}} sandboxed component{{totalSandboxes > 1 ? 's' : ''}}\n            </p>\n            <p *ngIf=\"totalSandboxes === 0\">\n                Get started - create your first sandbox! <a href=\"http://www.angularplayground.it/docs/how-to/sandboxing-components\" target=\"_blank\">Click here</a>.\n            </p>\n            <div class=\"content__shortcuts\">\n                <div class=\"content__shortcut\" *ngFor=\"let shortcut of shortcuts\">\n                    <div class=\"content__shortcut-label\">\n                        <ng-container *ngFor=\"let key of shortcut.keys; let i = index\">\n                            <code>\n                                {{key}}\n                            </code>\n                            <ng-container *ngIf=\"shortcut.keys.length > 1 && i < shortcut.keys.length - 1\">&nbsp;&nbsp;/&nbsp;&nbsp;</ng-container>\n                        </ng-container>\n                    </div>\n                    <div class=\"content__shortcut-value\">\n                        {{shortcut.description}}\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n    <ng-container *ngIf=\"selectedSandboxAndScenarioKeys.sandboxKey\">\n        <ap-scenario [selectedSandboxAndScenarioKeys]=\"selectedSandboxAndScenarioKeys\"></ap-scenario>\n    </ng-container>\n</section>\n",
            styles: ["*{box-sizing:border-box}:host{display:-webkit-box;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;flex-direction:column}.shield{height:100vh;opacity:0;position:absolute;z-index:2;width:100%}.command-bar{background-color:#252526;box-shadow:0 3px 8px 5px #000;color:#fff;display:-webkit-box;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;flex-direction:column;font-family:Consolas,monospace;left:50%;margin-top:-6px;max-height:100vh;padding-top:10px;position:absolute;-webkit-transform:translate(-50%,-120%);transform:translate(-50%,-120%);-webkit-transition:opacity .1s,-webkit-transform .1s;transition:transform .1s,opacity .1s,-webkit-transform .1s;width:376px;z-index:9999999999999}.command-bar::before{border-bottom:1px solid #000;content:\"\";display:block;position:absolute;top:61px;width:100%}.command-bar--open{min-height:60px;-webkit-transform:translate(-50%,0);transform:translate(-50%,0)}.command-bar--preview{opacity:.7}.command-bar__filter{background-color:#3c3c3c;border:1px solid #174a6c;color:#fff;font-family:Consolas,monospace;font-size:16px;margin:6px 0 0 5px;padding:8px;width:365px;z-index:1}.command-bar__filter::-webkit-input-placeholder{color:#a9a9a9}.command-bar__filter::-moz-placeholder{color:#a9a9a9}.command-bar__filter::-ms-input-placeholder{color:#a9a9a9}.command-bar__filter::placeholder{color:#a9a9a9}.command-bar__filter:-ms-input-placeholder{color:#a9a9a9}.command-bar__filter::-moz-focus-inner{border:0;padding:0}.command-bar__sandboxes{border-top:1px solid rgba(255,255,255,.1);margin-top:9px;overflow:auto;position:relative;max-height:calc(100vh - 109px)}.command-bar__sandboxes::-webkit-scrollbar{background-color:transparent;width:6px}.command-bar__sandboxes::-webkit-scrollbar-track{border-left:1px solid #000;background:rgba(255,255,255,.1)}.command-bar__sandboxes::-webkit-scrollbar-thumb{background-color:rgba(255,255,255,.1);margin-left:2px;width:4px}.command-bar__sandbox{border-bottom:1px solid #000;border-top:1px solid rgba(255,255,255,.1);padding:8px 6px 14px}.command-bar__sandbox:first-child{border-top:none}.command-bar__sandbox:last-child{border-bottom:none;padding-bottom:12px}.command-bar__title{-webkit-box-align:center;align-items:center;color:rgba(255,255,255,.5);display:-webkit-box;display:flex;font-family:Consolas,monospace;font-size:12px;font-weight:400;-webkit-box-pack:justify;justify-content:space-between;margin:0 0 5px;padding:5px 0 0}.command-bar__title ::ng-deep mark{background:0 0;color:#0097fb;font-weight:700}.command-bar__name{max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.command-bar__label{background:rgba(255,255,255,.1);border-radius:2px;display:block;font-size:10px;margin-left:10px;padding:4px 5px 3px}.command-bar__scenarios{display:-webkit-box;display:flex}.command-bar__scenario-link{-webkit-box-align:center;align-items:center;border-radius:2px;color:rgba(255,255,255,.5);cursor:pointer;display:-webkit-box;display:flex;padding:4px 3px;width:100%}.command-bar__scenario-link:active,.command-bar__scenario-link:focus,.command-bar__scenario-link:hover{background-color:#0097fb;color:#fff;outline-style:none}.command-bar__scenario-link:active .command-bar__scenario-icon,.command-bar__scenario-link:focus .command-bar__scenario-icon,.command-bar__scenario-link:hover .command-bar__scenario-icon{opacity:.5}.command-bar__scenario-label{line-height:1;max-width:calc(100% - 26px);min-width:calc(100% - 26px);padding-bottom:2px}.command-bar__scenario-link--selected{background:rgba(255,255,255,.1);color:#fff}.command-bar__scenario-link:active .command-bar__scenario-icon--selected,.command-bar__scenario-link:focus .command-bar__scenario-icon--selected,.command-bar__scenario-link:hover .command-bar__scenario-icon--selected{fill:#fff}.command-bar__brand{border-top:1px solid #000;display:block;position:relative;padding:9px 0 3px;text-align:center}.command-bar__brand::before{border-bottom:1px solid rgba(255,255,255,.1);content:\"\";display:block;left:0;position:absolute;top:0;width:100%}.command-bar__brand:hover .command-bar__logo__box{fill:rgba(255,255,255,.2)}.command-bar__brand:hover .command-bar__logo__letter{fill:rgba(255,255,255,.75)}.content__none{-webkit-box-align:center;align-items:center;border:0;display:-webkit-box;display:flex;min-height:calc(100vh - 4em);-webkit-box-pack:center;justify-content:center;padding-top:2em;padding-bottom:2em;position:relative;width:100%}.content__none-message{font-family:Arial,sans-serif;max-width:50%;min-width:450px;text-align:center}.content__none-message em{color:#666}.content__none-message p{font-size:20px}.content__shortcuts{border-top:1px solid #ccc;margin-top:2em;padding:30px 0 0 100px;width:520px}.content__shortcut{display:-webkit-box;display:flex}.content__shortcut-label{-webkit-box-align:center;align-items:center;display:-webkit-box;display:flex;font-size:11px;-webkit-box-pack:end;justify-content:flex-end;max-width:150px;min-width:150px;padding:8px 12px 8px 0;white-space:nowrap}.content__shortcut-label code{background:#eee;border:1px solid #ccc;border-radius:4px;padding:3px 7px}.content__shortcut-value{-webkit-box-align:center;align-items:center;display:-webkit-box;display:flex;font-size:11px;line-height:1.75;text-align:left;white-space:nowrap}"]
        }),
        __param(5, Inject(MIDDLEWARE))
    ], AppComponent);
    return AppComponent;
}());
export { AppComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2FuZ3VsYXItcGxheWdyb3VuZC8iLCJzb3VyY2VzIjpbImxpYi9jb3JlL2FwcC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFDSCxpQkFBaUIsRUFDakIsU0FBUyxFQUNULFVBQVUsRUFDVixNQUFNLEVBQ04sTUFBTSxFQUNOLFNBQVMsRUFDVCxZQUFZLEdBQ2YsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzdDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUV6RCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDdEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUM3RCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUNwRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDeEQsT0FBTyxFQUFjLFVBQVUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQzVELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDbEMsT0FBTyxFQUFFLFlBQVksRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBT3BFO0lBWUksc0JBQ1ksWUFBMEIsRUFDMUIsVUFBc0IsRUFDdEIsWUFBMEIsRUFDMUIsbUJBQXdDLEVBQ3hDLGlCQUFvQyxFQUNoQixVQUFrQztRQUx0RCxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3RCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7UUFDeEMsc0JBQWlCLEdB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LElBQUksQ0FBQztnQkFDeEIsV0FBVyxFQUFFLGdDQUFnQzthQUNoRDtZQUNEO2dCQUNJLElBQUksRUFBRSxDQUFDLEtBQUssQ0FBQztnQkFDYixXQUFXLEVBQUUsbUJBQW1CO2FBQ25DO1lBQ0Q7Z0JBQ0ksSUFBSSxFQUFFLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQztnQkFDMUIsV0FBVyxFQUFFLHlDQUF5QzthQUN6RDtZQUNEO2dCQUNJLElBQUksRUFBRSxDQUFDLGVBQWUsRUFBRSxlQUFlLENBQUM7Z0JBQ3hDLFdBQVcsRUFBRSxrRUFBa0U7YUFDbEY7U0FDSixDQUFDO0lBQ04sQ0FBQzs7Z0JBblN5QixZQUFZO2dCQUNkLFVBQVU7Z0JBQ1IsWUFBWTtnQkFDTCxtQkFBbUI7Z0JBQ3JCLGlCQUFpQjtnQkFDSixVQUFVLHVCQUFqRCxNQUFNLFNBQUMsVUFBVTs7SUFqQlc7UUFBaEMsWUFBWSxDQUFDLGlCQUFpQixDQUFDOzhEQUE2QztJQURwRSxZQUFZO1FBTHhCLFNBQVMsQ0FBQztZQUNQLFFBQVEsRUFBRSxpQkFBaUI7WUFDM0IsdW1MQUFtQzs7U0FFdEMsQ0FBQztRQW1CTyxXQUFBLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQTtPQWxCZCxZQUFZLENBaVR4QjtJQUFELG1CQUFDO0NBQUEsQUFqVEQsSUFpVEM7U0FqVFksWUFBWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gICAgQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gICAgQ29tcG9uZW50LFxuICAgIEVsZW1lbnRSZWYsXG4gICAgSW5qZWN0LFxuICAgIE9uSW5pdCxcbiAgICBRdWVyeUxpc3QsXG4gICAgVmlld0NoaWxkcmVuLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEZvcm1Db250cm9sIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgRXZlbnRNYW5hZ2VyIH0gZnJvbSAnQGFuZ3VsYXIvcGxhdGZvcm0tYnJvd3Nlcic7XG5pbXBvcnQgeyBTYW5kYm94TWVudUl0ZW0sIFNlbGVjdGVkU2FuZGJveEFuZFNjZW5hcmlvS2V5cyB9IGZyb20gJy4uL2xpYi9hcHAtc3RhdGUnO1xuaW1wb3J0IHsgU3RhdGVTZXJ2aWNlIH0gZnJvbSAnLi9zaGFyZWQvc3RhdGUuc2VydmljZSc7XG5pbXBvcnQgeyBVcmxTZXJ2aWNlIH0gZnJvbSAnLi9zaGFyZWQvdXJsLnNlcnZpY2UnO1xuaW1wb3J0IHsgZnV6enlTZWFyY2ggfSBmcm9tICcuL3NoYXJlZC9mdXp6eS1zZWFyY2guZnVuY3Rpb24nO1xuaW1wb3J0IHsgTGV2ZW5zaHRlaW5EaXN0YW5jZSB9IGZyb20gJy4vc2hhcmVkL2xldmVuc2h0ZWluLWRpc3RhbmNlJztcbmltcG9ydCB7IFNhbmRib3hMb2FkZXIgfSBmcm9tICcuL3NoYXJlZC9zYW5kYm94LWxvYWRlcic7XG5pbXBvcnQgeyBNaWRkbGV3YXJlLCBNSURETEVXQVJFIH0gZnJvbSAnLi4vbGliL21pZGRsZXdhcmVzJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRlYm91bmNlVGltZSwgZGlzdGluY3RVbnRpbENoYW5nZWQgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbkBDb21wb25lbnQoe1xuICAgIHNlbGVjdG9yOiAncGxheWdyb3VuZC1yb290JyxcbiAgICB0ZW1wbGF0ZVVybDogJy4vYXBwLmNvbXBvbmVudC5odG1sJyxcbiAgICBzdHlsZVVybHM6IFsnLi9hcHAuY29tcG9uZW50LmNzcyddLFxufSlcbmV4cG9ydCBjbGFzcyBBcHBDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuICAgIEBWaWV3Q2hpbGRyZW4oJ3NjZW5hcmlvRWxlbWVudCcpIHNjZW5hcmlvTGlua0VsZW1lbnRzOiBRdWVyeUxpc3Q8RWxlbWVudFJlZj47XG4gICAgY29tbWFuZEJhckFjdGl2ZSA9IGZhbHNlO1xuICAgIGNvbW1hbmRCYXJQcmV2aWV3ID0gZmFsc2U7XG4gICAgdG90YWxTYW5kYm94ZXM6IG51bWJlcjtcbiAgICBmaWx0ZXJlZFNhbmRib3hNZW51SXRlbXM6IFNhbmRib3hNZW51SXRlbVtdO1xuICAgIHNlbGVjdGVkU2FuZGJveEFuZFNjZW5hcmlvS2V5czogU2VsZWN0ZWRTYW5kYm94QW5kU2NlbmFyaW9LZXlzID0ge3NhbmRib3hLZXk6IG51bGwsIHNjZW5hcmlvS2V5OiBudWxsfTtcbiAgICBmaWx0ZXIgPSBuZXcgRm9ybUNvbnRyb2woKTtcbiAgICBzaG9ydGN1dHMgPSB0aGlzLmdldFNob3J0Y3V0cygpO1xuICAgIGFjdGl2ZU1pZGRsZXdhcmU6IE1pZGRsZXdhcmU7XG4gICAgZW1iZWQgPSBmYWxzZTtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIHN0YXRlU2VydmljZTogU3RhdGVTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIHVybFNlcnZpY2U6IFVybFNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgZXZlbnRNYW5hZ2VyOiBFdmVudE1hbmFnZXIsXG4gICAgICAgIHByaXZhdGUgbGV2ZW5zaHRlaW5EaXN0YW5jZTogTGV2ZW5zaHRlaW5EaXN0YW5jZSxcbiAgICAgICAgcHJpdmF0ZSBjaGFuZ2VEZXRlY3RvclJlZjogQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gICAgICAgIEBJbmplY3QoTUlERExFV0FSRSkgcHJpdmF0ZSBtaWRkbGV3YXJlOiBPYnNlcnZhYmxlPE1pZGRsZXdhcmU+LFxuICAgICkge1xuICAgIH1cblxuICAgIG5nT25Jbml0KCkge1xuICAgICAgICBjb25zdCBzYW5kYm94TWVudUl0ZW1zID0gU2FuZGJveExvYWRlci5nZXRTYW5kYm94TWVudUl0ZW1zKCk7XG5cbiAgICAgICAgdGhpcy5taWRkbGV3YXJlXG4gICAgICAgICAgICAuc3Vic2NyaWJlKG1pZGRsZXdhcmUgPT4gdGhpcy5hY3RpdmVNaWRkbGV3YXJlID0gbWlkZGxld2FyZSk7XG5cbiAgICAgICAgdGhpcy5lbWJlZCA9IHRoaXMudXJsU2VydmljZS5lbWJlZDtcbiAgICAgICAgaWYgKHRoaXMuZW1iZWQpIHtcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRTYW5kYm94QW5kU2NlbmFyaW9LZXlzID0ge1xuICAgICAgICAgICAgICAgIHNhbmRib3hLZXk6IHRoaXMudXJsU2VydmljZS5zZWxlY3Quc2FuZGJveEtleSxcbiAgICAgICAgICAgICAgICBzY2VuYXJpb0tleTogdGhpcy51cmxTZXJ2aWNlLnNlbGVjdC5zY2VuYXJpb0tleSxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAodGhpcy51cmxTZXJ2aWNlLnNlbGVjdCkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRTYW5kYm94QW5kU2NlbmFyaW9LZXlzID0ge1xuICAgICAgICAgICAgICAgICAgICBzYW5kYm94S2V5OiB0aGlzLnVybFNlcnZpY2Uuc2VsZWN0LnNhbmRib3hLZXksXG4gICAgICAgICAgICAgICAgICAgIHNjZW5hcmlvS2V5OiB0aGlzLnVybFNlcnZpY2Uuc2VsZWN0LnNjZW5hcmlvS2V5LFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuZXZlbnRNYW5hZ2VyLmFkZEdsb2JhbEV2ZW50TGlzdGVuZXIoJ3dpbmRvdycsICdrZXlkb3duLmNvbnRyb2wucCcsIHRoaXMuYmxvY2tFdmVudCk7XG4gICAgICAgICAgICB0aGlzLmV2ZW50TWFuYWdlci5hZGRHbG9iYWxFdmVudExpc3RlbmVyKCd3aW5kb3cnLCAna2V5ZG93bi5GMicsIHRoaXMuYmxvY2tFdmVudCk7XG5cbiAgICAgICAgICAgIHRoaXMuZXZlbnRNYW5hZ2VyLmFkZEdsb2JhbEV2ZW50TGlzdGVuZXIoJ3dpbmRvdycsICdrZXl1cC5jb250cm9sLnAnLCAoZXZlbnQ6IEtleWJvYXJkRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmJsb2NrRXZlbnQoZXZlbnQpO1xuICAgICAgICAgICAgICAgIHRoaXMudG9nZ2xlQ29tbWFuZEJhcigpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHRoaXMuZXZlbnRNYW5hZ2VyLmFkZEdsb2JhbEV2ZW50TGlzdGVuZXIoJ3dpbmRvdycsICdrZXl1cC5GMicsIChldmVudDogS2V5Ym9hcmRFdmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuYmxvY2tFdmVudChldmVudCk7XG4gICAgICAgICAgICAgICAgdGhpcy50b2dnbGVDb21tYW5kQmFyKCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgbGV0IGZpbHRlclZhbHVlID0gdGhpcy5zdGF0ZVNlcnZpY2UuZ2V0RmlsdGVyKCk7XG4gICAgICAgICAgICB0aGlzLnRvdGFsU2FuZGJveGVzID0gc2FuZGJveE1lbnVJdGVtcy5sZW5ndGg7XG4gICAgICAgICAgICB0aGlzLmZpbHRlcmVkU2FuZGJveE1lbnVJdGVtcyA9IHRoaXMuZmlsdGVyU2FuZGJveGVzKHNhbmRib3hNZW51SXRlbXMsIGZpbHRlclZhbHVlKTtcbiAgICAgICAgICAgIHRoaXMuZmlsdGVyLnNldFZhbHVlKGZpbHRlclZhbHVlKTtcbiAgICAgICAgICAgIHRoaXMuZmlsdGVyLnZhbHVlQ2hhbmdlcy5waXBlXG4gICAgICAgICAgICAoXG4gICAgICAgICAgICAgICAgZGVib3VuY2VUaW1lKDMwMCksXG4gICAgICAgICAgICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKHZhbHVlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0ZVNlcnZpY2Uuc2V0RmlsdGVyKHZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5maWx0ZXJlZFNhbmRib3hNZW51SXRlbXMgPSB0aGlzLmZpbHRlclNhbmRib3hlcyhzYW5kYm94TWVudUl0ZW1zLCB2YWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgIGlmICghdmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0U2NlbmFyaW8obnVsbCwgbnVsbCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGV4cG9zZSBzZWxlY3Qgc2NlbmFyaW8gZnVuY3Rpb25hbGl0eSBmb3IgdmlzdWFsIHJlZ3Jlc3Npb24gdGVzdFxuICAgICAgICAod2luZG93IGFzIGFueSkubG9hZFNjZW5hcmlvID0gKHNhbmRib3hLZXk6IHN0cmluZywgc2NlbmFyaW9LZXk6IG51bWJlcikgPT4ge1xuICAgICAgICAgICAgdGhpcy5zZWxlY3RTY2VuYXJpbyhzYW5kYm94S2V5LCBzY2VuYXJpb0tleSk7XG4gICAgICAgICAgICB0aGlzLmNoYW5nZURldGVjdG9yUmVmLmRldGVjdENoYW5nZXMoKTtcbiAgICAgICAgfTtcblxuICAgICAgICAvLyBzZXQgZmxhZyB0byBjaGVjayB3aGVuIGNvbXBvbmVudCBpcyBsb2FkZWRcbiAgICAgICAgKHdpbmRvdyBhcyBhbnkpLmlzUGxheWdyb3VuZENvbXBvbmVudExvYWRlZCA9ICgpID0+IGZhbHNlO1xuICAgICAgICAod2luZG93IGFzIGFueSkuaXNQbGF5Z3JvdW5kQ29tcG9uZW50TG9hZGVkV2l0aEVycm9ycyA9ICgpID0+IGZhbHNlO1xuICAgIH1cblxuICAgIG9uRmlsdGVyQm94QXJyb3dEb3duKGV2ZW50OiBhbnksIHN3aXRjaFRvU2NlbmFyaW8gPSBmYWxzZSkge1xuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBsZXQgZWxlbWVudFJlZjtcbiAgICAgICAgY29uc3QgY3VycmVudEluZGV4ID0gdGhpcy5maW5kQ3VycmVudFNjZW5hcmlvSW5kZXgoKTtcblxuICAgICAgICBpZiAoY3VycmVudEluZGV4KSB7XG4gICAgICAgICAgICBlbGVtZW50UmVmID0gdGhpcy5mb2N1c1NjZW5hcmlvTGlua0VsZW1lbnQoY3VycmVudEluZGV4ICsgMSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBlbGVtZW50UmVmID0gdGhpcy5mb2N1c1NjZW5hcmlvTGlua0VsZW1lbnQoMCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHN3aXRjaFRvU2NlbmFyaW8pIHtcbiAgICAgICAgICAgIHRoaXMuc2hvd1NjZW5hcmlvKGVsZW1lbnRSZWYpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgb25GaWx0ZXJCb3hBcnJvd1VwKGV2ZW50OiBhbnksIHN3aXRjaFRvU2NlbmFyaW8gPSBmYWxzZSkge1xuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBsZXQgZWxlbWVudFJlZjtcbiAgICAgICAgY29uc3QgY3VycmVudEluZGV4ID0gdGhpcy5maW5kQ3VycmVudFNjZW5hcmlvSW5kZXgoKTtcblxuICAgICAgICBpZiAoY3VycmVudEluZGV4KSB7XG4gICAgICAgICAgICBlbGVtZW50UmVmID0gdGhpcy5mb2N1c1NjZW5hcmlvTGlua0VsZW1lbnQoY3VycmVudEluZGV4IC0gMSk7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5zY2VuYXJpb0xpbmtFbGVtZW50cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBlbGVtZW50UmVmID0gdGhpcy5mb2N1c1NjZW5hcmlvTGlua0VsZW1lbnQodGhpcy5zY2VuYXJpb0xpbmtFbGVtZW50cy5sZW5ndGggLSAxKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoc3dpdGNoVG9TY2VuYXJpbykge1xuICAgICAgICAgICAgdGhpcy5zaG93U2NlbmFyaW8oZWxlbWVudFJlZik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBvblNjZW5hcmlvTGlua0tleURvd24oc2NlbmFyaW9FbGVtZW50OiBhbnksIGZpbHRlckVsZW1lbnQ6IGFueSwgZXZlbnQ6IGFueSkge1xuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBzd2l0Y2ggKGV2ZW50LmtleSkge1xuICAgICAgICAgICAgY2FzZSAnVXAnOlxuICAgICAgICAgICAgY2FzZSAnQXJyb3dVcCc6XG4gICAgICAgICAgICAgICAgdGhpcy5nb1VwKHNjZW5hcmlvRWxlbWVudCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdEb3duJzpcbiAgICAgICAgICAgIGNhc2UgJ0Fycm93RG93bic6XG4gICAgICAgICAgICAgICAgdGhpcy5nb0Rvd24oc2NlbmFyaW9FbGVtZW50KTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgaWYgKGV2ZW50LmtleSAhPT0gJ0VzY2FwZScgJiYgZXZlbnQua2V5ICE9PSAnRW50ZXInKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5rZXkubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZpbHRlci5zZXRWYWx1ZShgJHt0aGlzLmZpbHRlci52YWx1ZX0ke2V2ZW50LmtleX1gKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBmaWx0ZXJFbGVtZW50LmZvY3VzKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgb25TY2VuYXJpb0xpbmtLZXlVcChzY2VuYXJpb0VsZW1lbnQ6IGFueSwgZXZlbnQ6IGFueSkge1xuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBzd2l0Y2ggKGV2ZW50LmtleSkge1xuICAgICAgICAgICAgY2FzZSAnRXNjYXBlJzpcbiAgICAgICAgICAgICAgICB0aGlzLmNvbW1hbmRCYXJBY3RpdmUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ0VudGVyJzpcbiAgICAgICAgICAgICAgICBzY2VuYXJpb0VsZW1lbnQuY2xpY2soKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG9uU2NlbmFyaW9MaW5rQ29udHJvbERvd24oc2NlbmFyaW9FbGVtZW50OiBhbnksIGV2ZW50OiBhbnkpIHtcbiAgICAgICAgaWYgKCF0aGlzLmNvbW1hbmRCYXJBY3RpdmUpIHJldHVybjtcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgbGV0IGVsZW1lbnRSZWYgPSB0aGlzLmdvRG93bihzY2VuYXJpb0VsZW1lbnQpO1xuICAgICAgICB0aGlzLnNob3dTY2VuYXJpbyhlbGVtZW50UmVmKTtcbiAgICB9XG5cbiAgICBvblNjZW5hcmlvTGlua0NvbnRyb2xVcChzY2VuYXJpb0VsZW1lbnQ6IGFueSwgZXZlbnQ6IGFueSkge1xuICAgICAgICBpZiAoIXRoaXMuY29tbWFuZEJhckFjdGl2ZSkgcmV0dXJuO1xuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBsZXQgZWxlbWVudFJlZiA9IHRoaXMuZ29VcChzY2VuYXJpb0VsZW1lbnQpO1xuICAgICAgICB0aGlzLnNob3dTY2VuYXJpbyhlbGVtZW50UmVmKTtcbiAgICB9XG5cbiAgICBvbkNvbW1hbmRCYXJTdGFydFByZXZpZXcoZXZlbnQ6IGFueSkge1xuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICB0aGlzLmNvbW1hbmRCYXJQcmV2aWV3ID0gdHJ1ZTtcbiAgICB9XG5cbiAgICBvbkNvbW1hbmRCYXJTdG9wUHJldmlldygpIHtcbiAgICAgICAgdGhpcy5jb21tYW5kQmFyUHJldmlldyA9IGZhbHNlO1xuICAgIH1cblxuICAgIG9uU2NlbmFyaW9DbGljayhzYW5kYm94S2V5OiBzdHJpbmcsIHNjZW5hcmlvS2V5OiBudW1iZXIsIGV2ZW50OiBhbnkpIHtcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgdGhpcy5zZWxlY3RTY2VuYXJpbyhzYW5kYm94S2V5LCBzY2VuYXJpb0tleSk7XG4gICAgfVxuXG4gICAgaXNTZWxlY3RlZChzYW5kYm94OiBhbnksIHNjZW5hcmlvOiBhbnkpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VsZWN0ZWRTYW5kYm94QW5kU2NlbmFyaW9LZXlzLnNjZW5hcmlvS2V5ID09PSBzY2VuYXJpby5rZXlcbiAgICAgICAgICAgICYmIHRoaXMuc2VsZWN0ZWRTYW5kYm94QW5kU2NlbmFyaW9LZXlzLnNhbmRib3hLZXkudG9Mb3dlckNhc2UoKSA9PT0gc2FuZGJveC5rZXkudG9Mb3dlckNhc2UoKTtcbiAgICB9XG5cbiAgICB0b2dnbGVDb21tYW5kQmFyKCkge1xuICAgICAgICB0aGlzLmNvbW1hbmRCYXJBY3RpdmUgPSAhdGhpcy5jb21tYW5kQmFyQWN0aXZlO1xuICAgIH1cblxuICAgIHByaXZhdGUgYmxvY2tFdmVudChlOiBLZXlib2FyZEV2ZW50KSB7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNob3dTY2VuYXJpbyhzZWxlY3RlZFNjZW5hcmlvRWxlbWVudFJlZjogRWxlbWVudFJlZikge1xuICAgICAgICBpZiAoc2VsZWN0ZWRTY2VuYXJpb0VsZW1lbnRSZWYpIHtcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0U2NlbmFyaW8oXG4gICAgICAgICAgICAgICAgc2VsZWN0ZWRTY2VuYXJpb0VsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5nZXRBdHRyaWJ1dGUoJ3NhbmRib3hNZW51SXRlbUtleScpLFxuICAgICAgICAgICAgICAgIHBhcnNlSW50KHNlbGVjdGVkU2NlbmFyaW9FbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuZ2V0QXR0cmlidXRlKCdzY2VuYXJpb01lbnVJdGVta2V5JyksIDEwKSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGZpbmRDdXJyZW50U2NlbmFyaW9JbmRleCgpOiBudW1iZXIgfCB1bmRlZmluZWQge1xuICAgICAgICBsZXQgY3VycmVudEluZGV4O1xuXG4gICAgICAgIGlmICh0aGlzLnNjZW5hcmlvTGlua0VsZW1lbnRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHRoaXMuc2NlbmFyaW9MaW5rRWxlbWVudHMubWFwKChlbGVtZW50OiBFbGVtZW50UmVmLCBpOiBudW1iZXIpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC5uYXRpdmVFbGVtZW50LmNsYXNzTmFtZS5pbmNsdWRlcygnc2VsZWN0ZWQnKSkge1xuICAgICAgICAgICAgICAgICAgICBjdXJyZW50SW5kZXggPSBpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGN1cnJlbnRJbmRleDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdvVXAoc2NlbmFyaW9FbGVtZW50OiBhbnkpIHtcbiAgICAgICAgbGV0IGN1cnJlbnRJbmRleCA9IC0xO1xuXG4gICAgICAgIHRoaXMuc2NlbmFyaW9MaW5rRWxlbWVudHMuZm9yRWFjaCgoc2NlbmFyaW9FbGVtZW50UmVmOiBFbGVtZW50UmVmLCBpbmRleDogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgICBpZiAoc2NlbmFyaW9FbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQgPT09IHNjZW5hcmlvRWxlbWVudCkge1xuICAgICAgICAgICAgICAgIGN1cnJlbnRJbmRleCA9IGluZGV4O1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoY3VycmVudEluZGV4ID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5mb2N1c1NjZW5hcmlvTGlua0VsZW1lbnQodGhpcy5zY2VuYXJpb0xpbmtFbGVtZW50cy5sZW5ndGggLSAxKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmZvY3VzU2NlbmFyaW9MaW5rRWxlbWVudChjdXJyZW50SW5kZXggLSAxKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZ29Eb3duKHNjZW5hcmlvRWxlbWVudDogYW55KSB7XG4gICAgICAgIGxldCBjdXJyZW50SW5kZXggPSAtMTtcblxuICAgICAgICB0aGlzLnNjZW5hcmlvTGlua0VsZW1lbnRzLmZvckVhY2goKHNjZW5hcmlvRWxlbWVudFJlZjogRWxlbWVudFJlZiwgaW5kZXg6IG51bWJlcikgPT4ge1xuICAgICAgICAgICAgaWYgKHNjZW5hcmlvRWxlbWVudFJlZi5uYXRpdmVFbGVtZW50ID09PSBzY2VuYXJpb0VsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICBjdXJyZW50SW5kZXggPSBpbmRleDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKGN1cnJlbnRJbmRleCA9PT0gdGhpcy5zY2VuYXJpb0xpbmtFbGVtZW50cy5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5mb2N1c1NjZW5hcmlvTGlua0VsZW1lbnQoMCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5mb2N1c1NjZW5hcmlvTGlua0VsZW1lbnQoY3VycmVudEluZGV4ICsgMSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGZvY3VzU2NlbmFyaW9MaW5rRWxlbWVudChpbmRleDogbnVtYmVyKSB7XG4gICAgICAgIGlmICh0aGlzLnNjZW5hcmlvTGlua0VsZW1lbnRzLnRvQXJyYXkoKVtpbmRleF0pIHtcbiAgICAgICAgICAgIGxldCBlbGVtZW50UmVmID0gdGhpcy5zY2VuYXJpb0xpbmtFbGVtZW50cy50b0FycmF5KClbaW5kZXhdO1xuICAgICAgICAgICAgZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmZvY3VzKCk7XG4gICAgICAgICAgICByZXR1cm4gZWxlbWVudFJlZjtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZmlsdGVyU2FuZGJveGVzKHNhbmRib3hNZW51SXRlbXM6IFNhbmRib3hNZW51SXRlbVtdLCBmaWx0ZXI6IHN0cmluZykge1xuICAgICAgICBpZiAoIWZpbHRlcikge1xuICAgICAgICAgICAgcmV0dXJuIHNhbmRib3hNZW51SXRlbXMubWFwKChpdGVtLCBpKSA9PiBPYmplY3QuYXNzaWduKHt9LCBpdGVtLCB7dGFiSW5kZXg6IGl9KSk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgdGFiSW5kZXggPSAwO1xuICAgICAgICBsZXQgZmlsdGVyTm9ybWFsaXplZCA9IGZpbHRlci50b0xvd2VyQ2FzZSgpO1xuXG4gICAgICAgIHJldHVybiBzYW5kYm94TWVudUl0ZW1zXG4gICAgICAgICAgICAucmVkdWNlKChhY2N1bSwgY3VycikgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBzZWFyY2hLZXlOb3JtYWxpemVkID0gY3Vyci5zZWFyY2hLZXkudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgICAgICBsZXQgaW5kZXhNYXRjaGVzID0gZnV6enlTZWFyY2goZmlsdGVyTm9ybWFsaXplZCwgc2VhcmNoS2V5Tm9ybWFsaXplZCk7XG4gICAgICAgICAgICAgICAgaWYgKGluZGV4TWF0Y2hlcykge1xuICAgICAgICAgICAgICAgICAgICBsZXQgd2VpZ2h0ID0gdGhpcy5sZXZlbnNodGVpbkRpc3RhbmNlLmdldERpc3RhbmNlKGZpbHRlck5vcm1hbGl6ZWQsIHNlYXJjaEtleU5vcm1hbGl6ZWQpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gWy4uLmFjY3VtLCBPYmplY3QuYXNzaWduKHt9LCBjdXJyLCB7d2VpZ2h0LCBpbmRleE1hdGNoZXN9KV07XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFjY3VtO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sIFtdKVxuICAgICAgICAgICAgLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gYS53ZWlnaHQgLSBiLndlaWdodDtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAubWFwKHNhbmRib3hNZW51SXRlbSA9PiBPYmplY3QuYXNzaWduKHt9LCBzYW5kYm94TWVudUl0ZW0sIHt0YWJJbmRleDogdGFiSW5kZXgrK30pKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNlbGVjdFNjZW5hcmlvKHNhbmRib3hLZXk6IHN0cmluZywgc2NlbmFyaW9LZXk6IG51bWJlcikge1xuICAgICAgICAvLyBzZXQgZmxhZyB0byBjaGVjayB3aGVuIGNvbXBvbmVudCBpcyBsb2FkZWRcbiAgICAgICAgKHdpbmRvdyBhcyBhbnkpLmlzUGxheWdyb3VuZENvbXBvbmVudExvYWRlZCA9ICgpID0+IGZhbHNlO1xuICAgICAgICAod2luZG93IGFzIGFueSkuaXNQbGF5Z3JvdW5kQ29tcG9uZW50TG9hZGVkV2l0aEVycm9ycyA9ICgpID0+IGZhbHNlO1xuICAgICAgICB0aGlzLnNlbGVjdGVkU2FuZGJveEFuZFNjZW5hcmlvS2V5cyA9IHtzYW5kYm94S2V5LCBzY2VuYXJpb0tleX07XG4gICAgICAgIHRoaXMudXJsU2VydmljZS5zZXRTZWxlY3RlZChzYW5kYm94S2V5LCBzY2VuYXJpb0tleSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRTaG9ydGN1dHMoKSB7XG4gICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAga2V5czogWydjdHJsICsgcCcsICdmMiddLFxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnVG9nZ2xlIGNvbW1hbmQgYmFyIG9wZW4vY2xvc2VkJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAga2V5czogWydlc2MnXSxcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogJ0Nsb3NlIGNvbW1hbmQgYmFyJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAga2V5czogWydcXHUyMTkxJywgJ1xcdTIxOTMnXSxcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogJ05hdmlnYXRlIHVwIG9yIGRvd24gaW4gY29tbWFuZCBiYXIgbGlzdCcsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGtleXM6IFsnY3RybCArIFxcdTIxOTEnLCAnY3RybCArIFxcdTIxOTMnXSxcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogJ1N3aXRjaCBzY2VuYXJpb3Mgd2hpbGUgbmF2aWdhdGluZyB1cCBvciBkb3duIGluIGNvbW1hbmQgYmFyIGxpc3QnLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgXTtcbiAgICB9XG59XG4iXX0=