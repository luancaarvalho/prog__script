import { __decorate, __param, __read, __spread } from "tslib";
import { Component, Inject, Input, NgModule, NgModuleRef, NgZone, OnChanges, OnDestroy, OnInit, SimpleChanges, ÉµresetCompiledComponents as resetCompiledComponents } from '@angular/core';
import { platformBrowserDynamic } from '@angular/platform-browser-dynamic';
import { SandboxLoader } from '../shared/sandbox-loader';
import { BrowserModule } from '@angular/platform-browser';
import { MIDDLEWARE } from '../../lib/middlewares';
import { takeUntil } from 'rxjs/operators';
import { Subject } from 'rxjs';
var ScenarioComponent = /** @class */ (function () {
    function ScenarioComponent(zone, middleware) {
        this.zone = zone;
        this.middleware = middleware;
        /**
         * Collection of bootstrapped apps
         */
        this.activeApps = [];
        /**
         * Unsubscribe all subscriptions on component destroy
         */
        this.onDestroy = new Subject();
    }
    ScenarioComponent.prototype.ngOnInit = function () {
        var _this = this;
        this.middleware
            .pipe(takeUntil(this.onDestroy))
            .subscribe(function (middlewares) { return _this.activeMiddleware = middlewares; });
    };
    ScenarioComponent.prototype.ngOnChanges = function (changes) {
        if (changes.selectedSandboxAndScenarioKeys) {
            this.bootstrapSandbox(changes.selectedSandboxAndScenarioKeys.currentValue);
        }
    };
    ScenarioComponent.prototype.ngOnDestroy = function () {
        this.onDestroy.next();
        // this cleans up the DOM when a sandboxed component is loaded and the search bar is then cleared
        if (this.activeApps.length > 0) {
            // destroy sandboxed app (doesn't remove it from the DOM though)
            var app = this.activeApps.pop();
            app.destroy();
            // remove the sandboxed component's element from the dom
            var hostElement = document.querySelector('playground-host');
            if (hostElement && hostElement.children) {
                hostElement.children[0].remove();
            }
        }
    };
    /**
     * Bootstrap a new Angular application with the sandbox's required dependencies
     */
    ScenarioComponent.prototype.bootstrapSandbox = function (selectedSandboxAndScenarioKeys) {
        var _this = this;
        SandboxLoader.loadSandbox(selectedSandboxAndScenarioKeys.sandboxKey).then(function (sandbox) {
            if (sandbox) {
                var scenario_1 = sandbox.scenarios
                    .find(function (s) { return s.key === selectedSandboxAndScenarioKeys.scenarioKey; });
                if (scenario_1) {
                    if (_this.activeApps.length > 0) {
                        var app = _this.activeApps.pop();
                        app.destroy();
                    }
                    // Don't bootstrap a new Angular application within an existing zone
                    _this.zone.runOutsideAngular(function () {
                        var module = _this.createModule(sandbox, scenario_1);
                        platformBrowserDynamic().bootstrapModule(module)
                            .then(function (app) {
                            _this.activeApps.push(app);
                            resetCompiledComponents();
                            window.isPlaygroundComponentLoaded = function () { return true; };
                        })
                            .catch(function (err) {
                            resetCompiledComponents();
                            window.isPlaygroundComponentLoadedWithErrors = function () { return true; };
                            console.error(err);
                        });
                    });
                }
            }
        });
    };
    /**
     * Create a module containing the dependencies of a sandbox
     */
    ScenarioComponent.prototype.createModule = function (sandboxMeta, scenario) {
        var hostComp = this.createComponent(scenario);
        var DynamicModule = /** @class */ (function () {
            function DynamicModule() {
            }
            DynamicModule.prototype.ngDoBootstrap = function (app) {
                var hostEl = document.querySelector('playground-host');
                if (!hostEl) {
                    var compEl = document.createElement('playground-host');
                    document.body.appendChild(compEl);
                }
                app.bootstrap(hostComp);
            };
            return DynamicModule;
        }());
        return NgModule({
            imports: __spread([
                BrowserModule
            ], sandboxMeta.imports, this.activeMiddleware.modules),
            declarations: __spread([
                hostComp,
                sandboxMeta.declareComponent ? sandboxMeta.type : []
            ], sandboxMeta.declarations),
            providers: __spread(sandboxMeta.providers),
            entryComponents: __spread([hostComp], sandboxMeta.entryComponents),
            schemas: __spread(sandboxMeta.schemas),
        })(DynamicModule);
    };
    /**
     * Construct a component to serve as the host for the provided scenario
     */
    ScenarioComponent.prototype.createComponent = function (scenario) {
        var DynamicComponent = /** @class */ (function () {
            function DynamicComponent() {
                Object.assign(this, scenario.context);
            }
            return DynamicComponent;
        }());
        return Component({
            selector: 'playground-host',
            template: scenario.template,
            styles: scenario.styles,
            providers: scenario.providers,
        })(DynamicComponent);
    };
    ScenarioComponent.ctorParameters = function () { return [
        { type: NgZone },
        { type: undefined, decorators: [{ type: Inject, args: [MIDDLEWARE,] }] }
    ]; };
    __decorate([
        Input()
    ], ScenarioComponent.prototype, "selectedSandboxAndScenarioKeys", void 0);
    ScenarioComponent = __decorate([
        Component({
            selector: 'ap-scenario',
            template: "\n        <ng-template></ng-template>"
        }),
        __param(1, Inject(MIDDLEWARE))
    ], ScenarioComponent);
    return ScenarioComponent;
}());
export { ScenarioComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NlbmFyaW8uY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vYW5ndWxhci1wbGF5Z3JvdW5kLyIsInNvdXJjZXMiOlsibGliL2NvcmUvc2NlbmFyaW8vc2NlbmFyaW8uY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0gsU0FBUyxFQUNULE1BQU0sRUFDTixLQUFLLEVBQ0wsUUFBUSxFQUNSLFdBQVcsRUFDWCxNQUFNLEVBQ04sU0FBUyxFQUNULFNBQVMsRUFDVCxNQUFNLEVBQ04sYUFBYSxFQUNiLHdCQUF3QixJQUFJLHVCQUF1QixFQUN0RCxNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUMzRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFFekQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQzFELE9BQU8sRUFBYyxVQUFVLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQU8vQjtJQXFCSSwyQkFBb0IsSUFBWSxFQUE4QixVQUFVO1FBQXBELFNBQUksR0FBSixJQUFJLENBQVE7UUFBOEIsZUFBVSxHQUFWLFVBQVUsQ0FBQTtRQWZ4RTs7V0FFRztRQUNLLGVBQVUsR0FBdUIsRUFBRSxDQUFDO1FBTzVDOztXQUVHO1FBQ0ssY0FBUyxHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7SUFHeEMsQ0FBQztJQUVELG9DQUFRLEdBQVI7UUFBQSxpQkFJQztRQUhHLElBQUksQ0FBQyxVQUFVO2FBQ1YsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7YUFDL0IsU0FBUyxDQUFDLFVBQUEsV0FBVyxJQUFJLE9BQUEsS0FBSSxDQUFD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TTtZQUN2QixTQUFTLEVBQUUsUUFBUSxDQUFDLFNBQVM7U0FDaEMsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLENBQUM7SUFDekIsQ0FBQzs7Z0JBckh5QixNQUFNO2dEQUFHLE1BQU0sU0FBQyxVQUFVOztJQWpCM0M7UUFBUixLQUFLLEVBQUU7NkVBQWdFO0lBSi9ELGlCQUFpQjtRQUw3QixTQUFTLENBQUM7WUFDUCxRQUFRLEVBQUUsYUFBYTtZQUN2QixRQUFRLEVBQUUsdUNBQ3NCO1NBQ25DLENBQUM7UUFzQnFDLFdBQUEsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFBO09BckI1QyxpQkFBaUIsQ0EySTdCO0lBQUQsd0JBQUM7Q0FBQSxBQTNJRCxJQTJJQztTQTNJWSxpQkFBaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICAgIENvbXBvbmVudCxcbiAgICBJbmplY3QsXG4gICAgSW5wdXQsXG4gICAgTmdNb2R1bGUsXG4gICAgTmdNb2R1bGVSZWYsXG4gICAgTmdab25lLFxuICAgIE9uQ2hhbmdlcyxcbiAgICBPbkRlc3Ryb3ksXG4gICAgT25Jbml0LFxuICAgIFNpbXBsZUNoYW5nZXMsXG4gICAgybVyZXNldENvbXBpbGVkQ29tcG9uZW50cyBhcyByZXNldENvbXBpbGVkQ29tcG9uZW50c1xufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IHBsYXRmb3JtQnJvd3NlckR5bmFtaWMgfSBmcm9tICdAYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyLWR5bmFtaWMnO1xuaW1wb3J0IHsgU2FuZGJveExvYWRlciB9IGZyb20gJy4uL3NoYXJlZC9zYW5kYm94LWxvYWRlcic7XG5pbXBvcnQgeyBTY2VuYXJpbywgU2VsZWN0ZWRTYW5kYm94QW5kU2NlbmFyaW9LZXlzLCBTYW5kYm94IH0gZnJvbSAnLi4vLi4vbGliL2FwcC1zdGF0ZSc7XG5pbXBvcnQgeyBCcm93c2VyTW9kdWxlIH0gZnJvbSAnQGFuZ3VsYXIvcGxhdGZvcm0tYnJvd3Nlcic7XG5pbXBvcnQgeyBNaWRkbGV3YXJlLCBNSURETEVXQVJFIH0gZnJvbSAnLi4vLi4vbGliL21pZGRsZXdhcmVzJztcbmltcG9ydCB7IHRha2VVbnRpbCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICdhcC1zY2VuYXJpbycsXG4gICAgdGVtcGxhdGU6IGBcbiAgICAgICAgPG5nLXRlbXBsYXRlPjwvbmctdGVtcGxhdGU+YCxcbn0pXG5leHBvcnQgY2xhc3MgU2NlbmFyaW9Db21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcywgT25EZXN0cm95IHtcbiAgICAvKipcbiAgICAgKiBUaGUgc2VsZWN0ZWQgc2FuZGJveCBhbmQgc2NlbmFyaW8gcHJvdmlkZWQgZnJvbSB0aGUgYXBwIGRyb3Bkb3duXG4gICAgICovXG4gICAgQElucHV0KCkgc2VsZWN0ZWRTYW5kYm94QW5kU2NlbmFyaW9LZXlzOiBTZWxlY3RlZFNhbmRib3hBbmRTY2VuYXJpb0tleXM7XG5cbiAgICAvKipcbiAgICAgKiBDb2xsZWN0aW9uIG9mIGJvb3RzdHJhcHBlZCBhcHBzXG4gICAgICovXG4gICAgcHJpdmF0ZSBhY3RpdmVBcHBzOiBOZ01vZHVsZVJlZjxhbnk+W10gPSBbXTtcblxuICAgIC8qKlxuICAgICAqIE1vZHVsZXMgdGhhdCBhcmUgYXBwbGllZCBhY3Jvc3MgZXZlcnkgc2FuZGJveCBpbnN0YW5jZVxuICAgICAqL1xuICAgIHByaXZhdGUgYWN0aXZlTWlkZGxld2FyZTogTWlkZGxld2FyZTtcblxuICAgIC8qKlxuICAgICAqIFVuc3Vic2NyaWJlIGFsbCBzdWJzY3JpcHRpb25zIG9uIGNvbXBvbmVudCBkZXN0cm95XG4gICAgICovXG4gICAgcHJpdmF0ZSBvbkRlc3Ryb3kgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSB6b25lOiBOZ1pvbmUsIEBJbmplY3QoTUlERExFV0FSRSkgcHJpdmF0ZSBtaWRkbGV3YXJlKSB7XG4gICAgfVxuXG4gICAgbmdPbkluaXQoKSB7XG4gICAgICAgIHRoaXMubWlkZGxld2FyZVxuICAgICAgICAgICAgLnBpcGUodGFrZVVudGlsKHRoaXMub25EZXN0cm95KSlcbiAgICAgICAgICAgIC5zdWJzY3JpYmUobWlkZGxld2FyZXMgPT4gdGhpcy5hY3RpdmVNaWRkbGV3YXJlID0gbWlkZGxld2FyZXMpO1xuICAgIH1cblxuICAgIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICAgICAgaWYgKGNoYW5nZXMuc2VsZWN0ZWRTYW5kYm94QW5kU2NlbmFyaW9LZXlzKSB7XG4gICAgICAgICAgICB0aGlzLmJvb3RzdHJhcFNhbmRib3goY2hhbmdlcy5zZWxlY3RlZFNhbmRib3hBbmRTY2VuYXJpb0tleXMuY3VycmVudFZhbHVlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG5nT25EZXN0cm95KCkge1xuICAgICAgICB0aGlzLm9uRGVzdHJveS5uZXh0KCk7XG5cbiAgICAgICAgLy8gdGhpcyBjbGVhbnMgdXAgdGhlIERPTSB3aGVuIGEgc2FuZGJveGVkIGNvbXBvbmVudCBpcyBsb2FkZWQgYW5kIHRoZSBzZWFyY2ggYmFyIGlzIHRoZW4gY2xlYXJlZFxuICAgICAgICBpZiAodGhpcy5hY3RpdmVBcHBzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIC8vIGRlc3Ryb3kgc2FuZGJveGVkIGFwcCAoZG9lc24ndCByZW1vdmUgaXQgZnJvbSB0aGUgRE9NIHRob3VnaClcbiAgICAgICAgICAgIGNvbnN0IGFwcCA9IHRoaXMuYWN0aXZlQXBwcy5wb3AoKTtcbiAgICAgICAgICAgIGFwcC5kZXN0cm95KCk7XG5cbiAgICAgICAgICAgIC8vIHJlbW92ZSB0aGUgc2FuZGJveGVkIGNvbXBvbmVudCdzIGVsZW1lbnQgZnJvbSB0aGUgZG9tXG4gICAgICAgICAgICBjb25zdCBob3N0RWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ3BsYXlncm91bmQtaG9zdCcpO1xuICAgICAgICAgICAgaWYgKGhvc3RFbGVtZW50ICYmIGhvc3RFbGVtZW50LmNoaWxkcmVuKSB7XG4gICAgICAgICAgICAgICAgaG9zdEVsZW1lbnQuY2hpbGRyZW5bMF0ucmVtb3ZlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBCb290c3RyYXAgYSBuZXcgQW5ndWxhciBhcHBsaWNhdGlvbiB3aXRoIHRoZSBzYW5kYm94J3MgcmVxdWlyZWQgZGVwZW5kZW5jaWVzXG4gICAgICovXG4gICAgcHJpdmF0ZSBib290c3RyYXBTYW5kYm94KHNlbGVjdGVkU2FuZGJveEFuZFNjZW5hcmlvS2V5czogU2VsZWN0ZWRTYW5kYm94QW5kU2NlbmFyaW9LZXlzKSB7XG4gICAgICAgIFNhbmRib3hMb2FkZXIubG9hZFNhbmRib3goc2VsZWN0ZWRTYW5kYm94QW5kU2NlbmFyaW9LZXlzLnNhbmRib3hLZXkpLnRoZW4oc2FuZGJveCA9PiB7XG4gICAgICAgICAgICBpZiAoc2FuZGJveCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHNjZW5hcmlvID0gc2FuZGJveC5zY2VuYXJpb3NcbiAgICAgICAgICAgICAgICAgICAgLmZpbmQoKHM6IFNjZW5hcmlvKSA9PiBzLmtleSA9PT0gc2VsZWN0ZWRTYW5kYm94QW5kU2NlbmFyaW9LZXlzLnNjZW5hcmlvS2V5KTtcblxuICAgICAgICAgICAgICAgIGlmIChzY2VuYXJpbykge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5hY3RpdmVBcHBzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFwcCA9IHRoaXMuYWN0aXZlQXBwcy5wb3AoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5kZXN0cm95KCk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAvLyBEb24ndCBib290c3RyYXAgYSBuZXcgQW5ndWxhciBhcHBsaWNhdGlvbiB3aXRoaW4gYW4gZXhpc3Rpbmcgem9uZVxuICAgICAgICAgICAgICAgICAgICB0aGlzLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbW9kdWxlID0gdGhpcy5jcmVhdGVNb2R1bGUoc2FuZGJveCwgc2NlbmFyaW8pO1xuICAgICAgICAgICAgICAgICAgICAgICAgcGxhdGZvcm1Ccm93c2VyRHluYW1pYygpLmJvb3RzdHJhcE1vZHVsZShtb2R1bGUpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oYXBwID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVBcHBzLnB1c2goYXBwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzZXRDb21waWxlZENvbXBvbmVudHMoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHdpbmRvdyBhcyBhbnkpLmlzUGxheWdyb3VuZENvbXBvbmVudExvYWRlZCA9ICgpID0+IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzZXRDb21waWxlZENvbXBvbmVudHMoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHdpbmRvdyBhcyBhbnkpLmlzUGxheWdyb3VuZENvbXBvbmVudExvYWRlZFdpdGhFcnJvcnMgPSAoKSA9PiB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgbW9kdWxlIGNvbnRhaW5pbmcgdGhlIGRlcGVuZGVuY2llcyBvZiBhIHNhbmRib3hcbiAgICAgKi9cbiAgICBwcml2YXRlIGNyZWF0ZU1vZHVsZShzYW5kYm94TWV0YTogU2FuZGJveCwgc2NlbmFyaW8pIHtcbiAgICAgICAgY29uc3QgaG9zdENvbXAgPSB0aGlzLmNyZWF0ZUNvbXBvbmVudChzY2VuYXJpbyk7XG5cbiAgICAgICAgY2xhc3MgRHluYW1pY01vZHVsZSB7XG4gICAgICAgICAgICBuZ0RvQm9vdHN0cmFwKGFwcCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGhvc3RFbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ3BsYXlncm91bmQtaG9zdCcpO1xuICAgICAgICAgICAgICAgIGlmICghaG9zdEVsKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbXBFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3BsYXlncm91bmQtaG9zdCcpO1xuICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGNvbXBFbCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGFwcC5ib290c3RyYXAoaG9zdENvbXApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIE5nTW9kdWxlKHtcbiAgICAgICAgICAgIGltcG9ydHM6IFtcbiAgICAgICAgICAgICAgICBCcm93c2VyTW9kdWxlLFxuICAgICAgICAgICAgICAgIC4uLnNhbmRib3hNZXRhLmltcG9ydHMsXG4gICAgICAgICAgICAgICAgLi4udGhpcy5hY3RpdmVNaWRkbGV3YXJlLm1vZHVsZXMsXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgZGVjbGFyYXRpb25zOiBbXG4gICAgICAgICAgICAgICAgaG9zdENvbXAsXG4gICAgICAgICAgICAgICAgc2FuZGJveE1ldGEuZGVjbGFyZUNvbXBvbmVudCA/IHNhbmRib3hNZXRhLnR5cGUgOiBbXSxcbiAgICAgICAgICAgICAgICAuLi5zYW5kYm94TWV0YS5kZWNsYXJhdGlvbnMsXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgcHJvdmlkZXJzOiBbLi4uc2FuZGJveE1ldGEucHJvdmlkZXJzXSxcbiAgICAgICAgICAgIGVudHJ5Q29tcG9uZW50czogW2hvc3RDb21wLCAuLi5zYW5kYm94TWV0YS5lbnRyeUNvbXBvbmVudHNdLFxuICAgICAgICAgICAgc2NoZW1hczogWy4uLnNhbmRib3hNZXRhLnNjaGVtYXNdLFxuICAgICAgICB9KShEeW5hbWljTW9kdWxlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDb25zdHJ1Y3QgYSBjb21wb25lbnQgdG8gc2VydmUgYXMgdGhlIGhvc3QgZm9yIHRoZSBwcm92aWRlZCBzY2VuYXJpb1xuICAgICAqL1xuICAgIHByaXZhdGUgY3JlYXRlQ29tcG9uZW50KHNjZW5hcmlvOiBTY2VuYXJpbykge1xuICAgICAgICBjbGFzcyBEeW5hbWljQ29tcG9uZW50IHtcbiAgICAgICAgICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICAgICAgICAgIE9iamVjdC5hc3NpZ24odGhpcywgc2NlbmFyaW8uY29udGV4dCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gQ29tcG9uZW50KHtcbiAgICAgICAgICAgIHNlbGVjdG9yOiAncGxheWdyb3VuZC1ob3N0JyxcbiAgICAgICAgICAgIHRlbXBsYXRlOiBzY2VuYXJpby50ZW1wbGF0ZSxcbiAgICAgICAgICAgIHN0eWxlczogc2NlbmFyaW8uc3R5bGVzLFxuICAgICAgICAgICAgcHJvdmlkZXJzOiBzY2VuYXJpby5wcm92aWRlcnMsXG4gICAgICAgIH0pKER5bmFtaWNDb21wb25lbnQpO1xuICAgIH1cbn1cbiJdfQ==